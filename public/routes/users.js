'use strict';

var express = require('express');
var router = express.Router();
var passport = require('passport');
var User = require('../models/user');
var UDs = require('../models/major-list');
var Verify = require('./verify');
var nodemailer = require('nodemailer');
/* GET users listing. */
router.route('/').get(function (req, res, next) {
  User.find({}).populate('major').exec(function (err, user) {
    if (err) return next(err);
    res.json(user);
  });
}).delete(function (req, res, next) {
  User.remove({ "email": req.body.email }, function (err, resp) {
    if (err) return next(err);
    res.json(resp);
  });
});

//API user local signup : post /user/signup
router.post('/signup', function (req, res) {
  if (!Verify.verifyPasswordFormat(req.body.password)) {
    return done("Invalid password format, check the rule of making password.", false, req.flash('signupMessage', 'Invalid password format')); // req.flash is the way to set flashdata using connect-flash
  }

  User.register(new User({
    first_name: req.body.first_name,
    last_name: req.body.last_name,
    email: req.body.email }), req.body.password, function (err, user) {
    if (err) {
      return res.status(500).json({ err: err });
    }
    user.last_name = req.body.last_name;
    if (req.body.account_role === "Student") {
      user.account_role = "student";
    }

    if (req.body.account_role === "Advisor") {
      user.account_role = "advisor";
    }

    //process major

    user.save(function (err, user) {
      if (err) {
        console.error(err);
        res.status(302).json({ status: err });
      }
      return res.status(200).json({ status: 'Successfully registered, check actvition email.' });
    });
  });
});

//user local signin api : post /user/signin
router.post('/signin', function (req, res, next) {
  passport.authenticate('local', function (err, user, info) {
    if (err) {
      return next(err);
    }
    if (!user) {
      return res.status(401).json({
        err: info
      });
    }
    req.logIn(user, function (err) {
      if (err) {
        return res.status(500).json({
          err: 'Could not log in user'
        });
      }

      var token = Verify.getToken({ "username": user.username, "_id": user._id, "admin": user.admin });
      res.status(200).json({
        status: 'Login successful!',
        success: true,
        token: token
      });
    });
  })(req, res, next);
});

//user local logout api : post /user/logout
router.get('/logout', function (req, res) {
  req.logout();
  res.status(200).json({
    status: 'Bye!'
  });
});

//user faceback login api : get /user/facebook
router.get('/facebook', passport.authenticate('facebook'), function (req, res) {});

//usesr facebook callback api: get /facebook/callback
router.get('/facebook/callback', function (req, res, next) {
  passport.authenticate('facebook', function (err, user, info) {
    if (err) {
      return next(err);
    }
    if (!user) {
      return res.status(401).json({
        err: info
      });
    }
    req.logIn(user, function (err) {
      if (err) {
        return res.status(500).json({
          err: 'Could not log in user'
        });
      }
      var token = Verify.getToken(user);
      res.status(200).json({
        status: 'Login successful!',
        success: true,
        token: token
      });
    });
  })(req, res, next);
});

module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yb3V0ZXMvdXNlcnMuanMiXSwibmFtZXMiOlsiZXhwcmVzcyIsInJlcXVpcmUiLCJyb3V0ZXIiLCJSb3V0ZXIiLCJwYXNzcG9ydCIsIlVzZXIiLCJVRHMiLCJWZXJpZnkiLCJub2RlbWFpbGVyIiwicm91dGUiLCJnZXQiLCJyZXEiLCJyZXMiLCJuZXh0IiwiZmluZCIsInBvcHVsYXRlIiwiZXhlYyIsImVyciIsInVzZXIiLCJqc29uIiwiZGVsZXRlIiwicmVtb3ZlIiwiYm9keSIsImVtYWlsIiwicmVzcCIsInBvc3QiLCJ2ZXJpZnlQYXNzd29yZEZvcm1hdCIsInBhc3N3b3JkIiwiZG9uZSIsImZsYXNoIiwicmVnaXN0ZXIiLCJmaXJzdF9uYW1lIiwibGFzdF9uYW1lIiwic3RhdHVzIiwiYWNjb3VudF9yb2xlIiwic2F2ZSIsImNvbnNvbGUiLCJlcnJvciIsImF1dGhlbnRpY2F0ZSIsImluZm8iLCJsb2dJbiIsInRva2VuIiwiZ2V0VG9rZW4iLCJ1c2VybmFtZSIsIl9pZCIsImFkbWluIiwic3VjY2VzcyIsImxvZ291dCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSUEsVUFBVUMsUUFBUSxTQUFSLENBQWQ7QUFDQSxJQUFJQyxTQUFTRixRQUFRRyxNQUFSLEVBQWI7QUFDQSxJQUFJQyxXQUFXSCxRQUFRLFVBQVIsQ0FBZjtBQUNBLElBQUlJLE9BQU9KLFFBQVEsZ0JBQVIsQ0FBWDtBQUNBLElBQUlLLE1BQU1MLFFBQVEsc0JBQVIsQ0FBVjtBQUNBLElBQUlNLFNBQVlOLFFBQVEsVUFBUixDQUFoQjtBQUNBLElBQU1PLGFBQWFQLFFBQVEsWUFBUixDQUFuQjtBQUNBO0FBQ0FDLE9BQU9PLEtBQVAsQ0FBYSxHQUFiLEVBQ0NDLEdBREQsQ0FDSyxVQUFTQyxHQUFULEVBQWNDLEdBQWQsRUFBbUJDLElBQW5CLEVBQXlCO0FBQzVCUixPQUFLUyxJQUFMLENBQVUsRUFBVixFQUNHQyxRQURILENBQ1ksT0FEWixFQUVHQyxJQUZILENBRVEsVUFBVUMsR0FBVixFQUFjQyxJQUFkLEVBQW1CO0FBQ3pCLFFBQUlELEdBQUosRUFBUyxPQUFPSixLQUFLSSxHQUFMLENBQVA7QUFDVEwsUUFBSU8sSUFBSixDQUFTRCxJQUFUO0FBQ0QsR0FMRDtBQU1ELENBUkQsRUFTQ0UsTUFURCxDQVNRLFVBQVNULEdBQVQsRUFBYUMsR0FBYixFQUFpQkMsSUFBakIsRUFBc0I7QUFDNUJSLE9BQUtnQixNQUFMLENBQVksRUFBQyxTQUFRVixJQUFJVyxJQUFKLENBQVNDLEtBQWxCLEVBQVosRUFBc0MsVUFBVU4sR0FBVixFQUFlTyxJQUFmLEVBQXFCO0FBQ3JELFFBQUlQLEdBQUosRUFBUyxPQUFPSixLQUFLSSxHQUFMLENBQVA7QUFDVEwsUUFBSU8sSUFBSixDQUFTSyxJQUFUO0FBQ0gsR0FISDtBQUlELENBZEQ7O0FBZ0JBO0FBQ0F0QixPQUFPdUIsSUFBUCxDQUFZLFNBQVosRUFBdUIsVUFBU2QsR0FBVCxFQUFjQyxHQUFkLEVBQW1CO0FBQ3RDLE1BQUksQ0FBQ0wsT0FBT21CLG9CQUFQLENBQTRCZixJQUFJVyxJQUFKLENBQVNLLFFBQXJDLENBQUwsRUFBcUQ7QUFDN0MsV0FBT0MsS0FBSyw2REFBTCxFQUFvRSxLQUFwRSxFQUEyRWpCLElBQUlrQixLQUFKLENBQVUsZUFBVixFQUEyQix5QkFBM0IsQ0FBM0UsQ0FBUCxDQUQ2QyxDQUM2RjtBQUNqSjs7QUFFRHhCLE9BQUt5QixRQUFMLENBQWMsSUFBSXpCLElBQUosQ0FBUztBQUNFMEIsZ0JBQVdwQixJQUFJVyxJQUFKLENBQVNTLFVBRHRCO0FBRUVDLGVBQVVyQixJQUFJVyxJQUFKLENBQVNVLFNBRnJCO0FBR0VULFdBQU9aLElBQUlXLElBQUosQ0FBU0MsS0FIbEIsRUFBVCxDQUFkLEVBSUVaLElBQUlXLElBQUosQ0FBU0ssUUFKWCxFQUlxQixVQUFTVixHQUFULEVBQWNDLElBQWQsRUFBb0I7QUFDckMsUUFBSUQsR0FBSixFQUFTO0FBQ0wsYUFBT0wsSUFBSXFCLE1BQUosQ0FBVyxHQUFYLEVBQWdCZCxJQUFoQixDQUFxQixFQUFDRixLQUFLQSxHQUFOLEVBQXJCLENBQVA7QUFDSDtBQUNEQyxTQUFLYyxTQUFMLEdBQWlCckIsSUFBSVcsSUFBSixDQUFTVSxTQUExQjtBQUNBLFFBQUlyQixJQUFJVyxJQUFKLENBQVNZLFlBQVQsS0FBMEIsU0FBOUIsRUFBeUM7QUFDckNoQixXQUFLZ0IsWUFBTCxHQUFvQixTQUFwQjtBQUNIOztBQUVELFFBQUl2QixJQUFJVyxJQUFKLENBQVNZLFlBQVQsS0FBMEIsU0FBOUIsRUFBeUM7QUFDckNoQixXQUFLZ0IsWUFBTCxHQUFvQixTQUFwQjtBQUNIOztBQUVEOztBQUVBaEIsU0FBS2lCLElBQUwsQ0FBVSxVQUFTbEIsR0FBVCxFQUFhQyxJQUFiLEVBQW1CO0FBQ3pCLFVBQUlELEdBQUosRUFBUztBQUNQbUIsZ0JBQVFDLEtBQVIsQ0FBY3BCLEdBQWQ7QUFDQUwsWUFBSXFCLE1BQUosQ0FBVyxHQUFYLEVBQWdCZCxJQUFoQixDQUFxQixFQUFDYyxRQUFRaEIsR0FBVCxFQUFyQjtBQUNEO0FBQ0QsYUFBT0wsSUFBSXFCLE1BQUosQ0FBVyxHQUFYLEVBQWdCZCxJQUFoQixDQUFxQixFQUFDYyxRQUFRLGlEQUFULEVBQXJCLENBQVA7QUFDSCxLQU5EO0FBT0gsR0ExQkQ7QUEyQkgsQ0FoQ0Q7O0FBa0NBO0FBQ0EvQixPQUFPdUIsSUFBUCxDQUFZLFNBQVosRUFBdUIsVUFBU2QsR0FBVCxFQUFjQyxHQUFkLEVBQW1CQyxJQUFuQixFQUF5QjtBQUM5Q1QsV0FBU2tDLFlBQVQsQ0FBc0IsT0FBdEIsRUFBK0IsVUFBU3JCLEdBQVQsRUFBY0MsSUFBZCxFQUFvQnFCLElBQXBCLEVBQTBCO0FBQ3ZELFFBQUl0QixHQUFKLEVBQVM7QUFDUCxhQUFPSixLQUFLSSxHQUFMLENBQVA7QUFDRDtBQUNELFFBQUksQ0FBQ0MsSUFBTCxFQUFXO0FBQ1QsYUFBT04sSUFBSXFCLE1BQUosQ0FBVyxHQUFYLEVBQWdCZCxJQUFoQixDQUFxQjtBQUMxQkYsYUFBS3NCO0FBRHFCLE9BQXJCLENBQVA7QUFHRDtBQUNENUIsUUFBSTZCLEtBQUosQ0FBVXRCLElBQVYsRUFBZ0IsVUFBU0QsR0FBVCxFQUFjO0FBQzVCLFVBQUlBLEdBQUosRUFBUztBQUNQLGVBQU9MLElBQUlxQixNQUFKLENBQVcsR0FBWCxFQUFnQmQsSUFBaEIsQ0FBcUI7QUFDMUJGLGVBQUs7QUFEcUIsU0FBckIsQ0FBUDtBQUdEOztBQUVELFVBQUl3QixRQUFRbEMsT0FBT21DLFFBQVAsQ0FBZ0IsRUFBQyxZQUFXeEIsS0FBS3lCLFFBQWpCLEVBQTJCLE9BQU16QixLQUFLMEIsR0FBdEMsRUFBMkMsU0FBUTFCLEtBQUsyQixLQUF4RCxFQUFoQixDQUFaO0FBQ0FqQyxVQUFJcUIsTUFBSixDQUFXLEdBQVgsRUFBZ0JkLElBQWhCLENBQXFCO0FBQ25CYyxnQkFBUSxtQkFEVztBQUVuQmEsaUJBQVMsSUFGVTtBQUduQkwsZUFBT0E7QUFIWSxPQUFyQjtBQUtELEtBYkQ7QUFjRCxHQXZCRCxFQXVCRzlCLEdBdkJILEVBdUJPQyxHQXZCUCxFQXVCV0MsSUF2Qlg7QUF3QkQsQ0F6QkQ7O0FBMkJBO0FBQ0FYLE9BQU9RLEdBQVAsQ0FBVyxTQUFYLEVBQXNCLFVBQVNDLEdBQVQsRUFBY0MsR0FBZCxFQUFtQjtBQUNyQ0QsTUFBSW9DLE1BQUo7QUFDRm5DLE1BQUlxQixNQUFKLENBQVcsR0FBWCxFQUFnQmQsSUFBaEIsQ0FBcUI7QUFDbkJjLFlBQVE7QUFEVyxHQUFyQjtBQUdELENBTEQ7O0FBT0E7QUFDQS9CLE9BQU9RLEdBQVAsQ0FBVyxXQUFYLEVBQXdCTixTQUFTa0MsWUFBVCxDQUFzQixVQUF0QixDQUF4QixFQUNFLFVBQVMzQixHQUFULEVBQWNDLEdBQWQsRUFBa0IsQ0FBRSxDQUR0Qjs7QUFHQTtBQUNBVixPQUFPUSxHQUFQLENBQVcsb0JBQVgsRUFBaUMsVUFBU0MsR0FBVCxFQUFhQyxHQUFiLEVBQWlCQyxJQUFqQixFQUFzQjtBQUNyRFQsV0FBU2tDLFlBQVQsQ0FBc0IsVUFBdEIsRUFBa0MsVUFBU3JCLEdBQVQsRUFBY0MsSUFBZCxFQUFvQnFCLElBQXBCLEVBQTBCO0FBQzFELFFBQUl0QixHQUFKLEVBQVM7QUFDUCxhQUFPSixLQUFLSSxHQUFMLENBQVA7QUFDRDtBQUNELFFBQUksQ0FBQ0MsSUFBTCxFQUFXO0FBQ1QsYUFBT04sSUFBSXFCLE1BQUosQ0FBVyxHQUFYLEVBQWdCZCxJQUFoQixDQUFxQjtBQUMxQkYsYUFBS3NCO0FBRHFCLE9BQXJCLENBQVA7QUFHRDtBQUNENUIsUUFBSTZCLEtBQUosQ0FBVXRCLElBQVYsRUFBZ0IsVUFBU0QsR0FBVCxFQUFjO0FBQzVCLFVBQUlBLEdBQUosRUFBUztBQUNQLGVBQU9MLElBQUlxQixNQUFKLENBQVcsR0FBWCxFQUFnQmQsSUFBaEIsQ0FBcUI7QUFDMUJGLGVBQUs7QUFEcUIsU0FBckIsQ0FBUDtBQUdEO0FBQ0QsVUFBSXdCLFFBQVFsQyxPQUFPbUMsUUFBUCxDQUFnQnhCLElBQWhCLENBQVo7QUFDQU4sVUFBSXFCLE1BQUosQ0FBVyxHQUFYLEVBQWdCZCxJQUFoQixDQUFxQjtBQUNuQmMsZ0JBQVEsbUJBRFc7QUFFbkJhLGlCQUFTLElBRlU7QUFHbkJMLGVBQU9BO0FBSFksT0FBckI7QUFLRCxLQVpEO0FBYUQsR0F0QkQsRUFzQkc5QixHQXRCSCxFQXNCT0MsR0F0QlAsRUFzQldDLElBdEJYO0FBdUJELENBeEJEOztBQTBCQW1DLE9BQU9DLE9BQVAsR0FBaUIvQyxNQUFqQiIsImZpbGUiOiJ1c2Vycy5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBleHByZXNzID0gcmVxdWlyZSgnZXhwcmVzcycpO1xudmFyIHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG52YXIgcGFzc3BvcnQgPSByZXF1aXJlKCdwYXNzcG9ydCcpO1xudmFyIFVzZXIgPSByZXF1aXJlKCcuLi9tb2RlbHMvdXNlcicpO1xudmFyIFVEcyA9IHJlcXVpcmUoJy4uL21vZGVscy9tYWpvci1saXN0Jyk7XG52YXIgVmVyaWZ5ICAgID0gcmVxdWlyZSgnLi92ZXJpZnknKTtcbmNvbnN0IG5vZGVtYWlsZXIgPSByZXF1aXJlKCdub2RlbWFpbGVyJyk7XG4vKiBHRVQgdXNlcnMgbGlzdGluZy4gKi9cbnJvdXRlci5yb3V0ZSgnLycpXG4uZ2V0KGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gIFVzZXIuZmluZCh7fSlcbiAgICAucG9wdWxhdGUoJ21ham9yJylcbiAgICAuZXhlYyhmdW5jdGlvbiAoZXJyLHVzZXIpe1xuICAgIGlmIChlcnIpIHJldHVybiBuZXh0KGVycik7XG4gICAgcmVzLmpzb24odXNlcik7XG4gIH0pO1xufSlcbi5kZWxldGUoZnVuY3Rpb24ocmVxLHJlcyxuZXh0KXtcbiAgVXNlci5yZW1vdmUoe1wiZW1haWxcIjpyZXEuYm9keS5lbWFpbH0sIGZ1bmN0aW9uIChlcnIsIHJlc3ApIHtcbiAgICAgICAgaWYgKGVycikgcmV0dXJuIG5leHQoZXJyKTtcbiAgICAgICAgcmVzLmpzb24ocmVzcCk7XG4gICAgfSk7XG59KTtcblxuLy9BUEkgdXNlciBsb2NhbCBzaWdudXAgOiBwb3N0IC91c2VyL3NpZ251cFxucm91dGVyLnBvc3QoJy9zaWdudXAnLCBmdW5jdGlvbihyZXEsIHJlcykge1xuICAgIGlmICghVmVyaWZ5LnZlcmlmeVBhc3N3b3JkRm9ybWF0KHJlcS5ib2R5LnBhc3N3b3JkKSkge1xuICAgICAgICAgICAgcmV0dXJuIGRvbmUoXCJJbnZhbGlkIHBhc3N3b3JkIGZvcm1hdCwgY2hlY2sgdGhlIHJ1bGUgb2YgbWFraW5nIHBhc3N3b3JkLlwiLCBmYWxzZSwgcmVxLmZsYXNoKCdzaWdudXBNZXNzYWdlJywgJ0ludmFsaWQgcGFzc3dvcmQgZm9ybWF0JykpOyAvLyByZXEuZmxhc2ggaXMgdGhlIHdheSB0byBzZXQgZmxhc2hkYXRhIHVzaW5nIGNvbm5lY3QtZmxhc2hcbiAgICB9XG5cbiAgICBVc2VyLnJlZ2lzdGVyKG5ldyBVc2VyKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyc3RfbmFtZTpyZXEuYm9keS5maXJzdF9uYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXN0X25hbWU6cmVxLmJvZHkubGFzdF9uYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWFpbDogcmVxLmJvZHkuZW1haWx9KSxcbiAgICAgIHJlcS5ib2R5LnBhc3N3b3JkLCBmdW5jdGlvbihlcnIsIHVzZXIpIHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtlcnI6IGVycn0pO1xuICAgICAgICB9XG4gICAgICAgIHVzZXIubGFzdF9uYW1lID0gcmVxLmJvZHkubGFzdF9uYW1lO1xuICAgICAgICBpZiAocmVxLmJvZHkuYWNjb3VudF9yb2xlID09PSBcIlN0dWRlbnRcIikge1xuICAgICAgICAgICAgdXNlci5hY2NvdW50X3JvbGUgPSBcInN0dWRlbnRcIjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChyZXEuYm9keS5hY2NvdW50X3JvbGUgPT09IFwiQWR2aXNvclwiKSB7XG4gICAgICAgICAgICB1c2VyLmFjY291bnRfcm9sZSA9IFwiYWR2aXNvclwiO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9wcm9jZXNzIG1ham9yXG5cbiAgICAgICAgdXNlci5zYXZlKGZ1bmN0aW9uKGVycix1c2VyKSB7XG4gICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgcmVzLnN0YXR1cygzMDIpLmpzb24oe3N0YXR1czogZXJyfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oe3N0YXR1czogJ1N1Y2Nlc3NmdWxseSByZWdpc3RlcmVkLCBjaGVjayBhY3R2aXRpb24gZW1haWwuJ30pO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn0pO1xuXG4vL3VzZXIgbG9jYWwgc2lnbmluIGFwaSA6IHBvc3QgL3VzZXIvc2lnbmluXG5yb3V0ZXIucG9zdCgnL3NpZ25pbicsIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gIHBhc3Nwb3J0LmF1dGhlbnRpY2F0ZSgnbG9jYWwnLCBmdW5jdGlvbihlcnIsIHVzZXIsIGluZm8pIHtcbiAgICBpZiAoZXJyKSB7XG4gICAgICByZXR1cm4gbmV4dChlcnIpO1xuICAgIH1cbiAgICBpZiAoIXVzZXIpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIGVycjogaW5mb1xuICAgICAgfSk7XG4gICAgfVxuICAgIHJlcS5sb2dJbih1c2VyLCBmdW5jdGlvbihlcnIpIHtcbiAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNTAwKS5qc29uKHtcbiAgICAgICAgICBlcnI6ICdDb3VsZCBub3QgbG9nIGluIHVzZXInXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICB2YXIgdG9rZW4gPSBWZXJpZnkuZ2V0VG9rZW4oe1widXNlcm5hbWVcIjp1c2VyLnVzZXJuYW1lLCBcIl9pZFwiOnVzZXIuX2lkLCBcImFkbWluXCI6dXNlci5hZG1pbn0pO1xuICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oe1xuICAgICAgICBzdGF0dXM6ICdMb2dpbiBzdWNjZXNzZnVsIScsXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIHRva2VuOiB0b2tlblxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pKHJlcSxyZXMsbmV4dCk7XG59KTtcblxuLy91c2VyIGxvY2FsIGxvZ291dCBhcGkgOiBwb3N0IC91c2VyL2xvZ291dFxucm91dGVyLmdldCgnL2xvZ291dCcsIGZ1bmN0aW9uKHJlcSwgcmVzKSB7XG4gICAgcmVxLmxvZ291dCgpO1xuICByZXMuc3RhdHVzKDIwMCkuanNvbih7XG4gICAgc3RhdHVzOiAnQnllISdcbiAgfSk7XG59KTtcblxuLy91c2VyIGZhY2ViYWNrIGxvZ2luIGFwaSA6IGdldCAvdXNlci9mYWNlYm9va1xucm91dGVyLmdldCgnL2ZhY2Vib29rJywgcGFzc3BvcnQuYXV0aGVudGljYXRlKCdmYWNlYm9vaycpLFxuICBmdW5jdGlvbihyZXEsIHJlcyl7fSk7XG5cbi8vdXNlc3IgZmFjZWJvb2sgY2FsbGJhY2sgYXBpOiBnZXQgL2ZhY2Vib29rL2NhbGxiYWNrXG5yb3V0ZXIuZ2V0KCcvZmFjZWJvb2svY2FsbGJhY2snLCBmdW5jdGlvbihyZXEscmVzLG5leHQpe1xuICBwYXNzcG9ydC5hdXRoZW50aWNhdGUoJ2ZhY2Vib29rJywgZnVuY3Rpb24oZXJyLCB1c2VyLCBpbmZvKSB7XG4gICAgaWYgKGVycikge1xuICAgICAgcmV0dXJuIG5leHQoZXJyKTtcbiAgICB9XG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDEpLmpzb24oe1xuICAgICAgICBlcnI6IGluZm9cbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXEubG9nSW4odXNlciwgZnVuY3Rpb24oZXJyKSB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDUwMCkuanNvbih7XG4gICAgICAgICAgZXJyOiAnQ291bGQgbm90IGxvZyBpbiB1c2VyJ1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIHZhciB0b2tlbiA9IFZlcmlmeS5nZXRUb2tlbih1c2VyKTtcbiAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgc3RhdHVzOiAnTG9naW4gc3VjY2Vzc2Z1bCEnLFxuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICB0b2tlbjogdG9rZW5cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KShyZXEscmVzLG5leHQpO1xufSk7XG5cbm1vZHVsZS5leHBvcnRzID0gcm91dGVyO1xuIl19